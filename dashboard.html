<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Invitados - Boda Karen & Fabián</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts para tipografía elegante -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f7f3ed; /* Consistent background with invitation */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            box-sizing: border-box; /* Ensures padding doesn't cause overflow */
        }
        .dashboard-card {
            background: #ffffff;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.08); /* Sombra ligeramente más pronunciada */
            border: 1px solid #d4c8bc; /* Borde más sutil */
            border-radius: 1.25rem; /* Bordes un poco más redondeados */
            padding: 2.5rem; /* Mayor padding */
            text-align: center;
            width: 100%;
            max-width: 550px; /* Ligeramente más ancho */
            margin: 1.5rem auto; /* Más margen */
        }
        .golden-text {
            color: #a07a1e;
        }
        .display-font {
            font-family: 'Playfair Display', serif;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0.5rem; /* Mayor padding interno */
            border-bottom: 1px dashed #e7e2da; /* Línea más clara */
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-label {
            font-size: 1.2rem; /* Ligeramente más grande */
            color: #4B5563; /* gray-700 */
            font-family: 'Playfair Display', serif; /* Usar fuente display también aquí */
        }
        .stat-value {
            font-size: 1.8rem; /* Más grande y llamativo */
            font-weight: 700; /* font-bold */
            color: #a07a1e; /* golden-text */
        }
        .message-box {
            background-color: #fefcbf; /* Tailwind yellow-100 */
            color: #8b5f0a; /* Tailwind yellow-800 */
            border: 1px solid #fbd38d; /* Tailwind yellow-400 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem; /* Más margen superior */
            font-size: 0.95rem; /* Ligeramente más grande */
            text-align: left;
        }
        .error-box {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
            border: 1px solid #fca5a5; /* Tailwind red-400 */
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .dashboard-card {
                padding: 1.5rem; /* Ajuste para móviles */
            }
            .stat-label {
                font-size: 1.05rem;
            }
            .stat-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-card">
        <h1 class="text-3xl md:text-4xl display-font golden-text mb-8">Resumen de Asistencia</h1>

        <div id="loadingMessage" class="message-box">
            <i class="ph ph-hourglass-simple-fill animate-pulse mr-2"></i> Cargando datos...
        </div>

        <div id="errorMessage" class="message-box error-box hidden">
            <i class="ph ph-x-circle-fill mr-2"></i> Hubo un error al cargar los datos. Por favor, inténtalo de nuevo más tarde o verifica tu conexión a internet.
        </div>

        <div id="dataContainer" class="hidden space-y-4">
            <div class="stat-item">
                <span class="stat-label">Total de Confirmaciones (Personas):</span>
                <span id="totalConfirmedGuests" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Adultos Confirmados:</span>
                <span id="totalAdults" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Menores Confirmados:</span>
                <span id="totalMinors" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Número total de RSVP:</span>
                <span id="totalRsvpEntries" class="stat-value">0</span>
            </div>
        </div>

        <a href="https://9549552895.github.io/mi-boda-karen-fabian/" class="inline-block mt-10 bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-full shadow-md hover:bg-gray-300 transform hover:scale-105 active:scale-95 transition-all duration-300">
            <i class="ph ph-arrow-left-bold mr-2"></i> Volver a la Invitación
        </a>
    </div>

    <!-- SDKs de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // TU CONFIGURACIÓN DE FIREBASE (Misma que en index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDpAxNRADMfHkSlxBpJIe9WaB3_rWz1Vd4", 
            authDomain: "miappboda.firebaseapp.com",
            projectId: "miappboda",
            storageBucket: "miappboda.firebasestorage.app",
            messagingSenderId: "155595716187",
            appId: "1:155595716187:web:11ba23c2bde759bcf0717e",
            measurementId: "G-CL89DVBBHP" 
        };
        
        // Obtenemos el appId de la configuración de Firebase
        const appId = firebaseConfig.appId;

        let db, auth;

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const dataContainer = document.getElementById('dataContainer');

            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            dataContainer.classList.add('hidden');

            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously for data access
                await signInAnonymously(auth);
                console.log("Firebase Authenticated for dashboard.");

                // Reference to the 'rsvps' collection (public data)
                const rsvpsCollectionRef = collection(db, `artifacts/${appId}/public/data/rsvps`);

                // Query for documents where status is 'confirmed'
                const q = query(rsvpsCollectionRef, where("status", "==", "confirmed"));
                const querySnapshot = await getDocs(q);

                let totalAdults = 0;
                let totalMinors = 0;
                let totalRsvpEntries = 0; // Count of distinct RSVP submissions (not guests)

                querySnapshot.forEach((doc) => {
                    const rsvpData = doc.data();
                    totalAdults += rsvpData.adults || 0;
                    totalMinors += rsvpData.minors || 0;
                    totalRsvpEntries++;
                });

                const totalConfirmedGuests = totalAdults + totalMinors;

                // Update the DOM with the fetched data
                document.getElementById('totalConfirmedGuests').textContent = totalConfirmedGuests;
                document.getElementById('totalAdults').textContent = totalAdults;
                document.getElementById('totalMinors').textContent = totalMinors;
                document.getElementById('totalRsvpEntries').textContent = totalRsvpEntries;

                loadingMessage.classList.add('hidden');
                dataContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching RSVP data:", error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
