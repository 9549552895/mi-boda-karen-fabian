<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Elegante - Karen & Fabián</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts para tipografía elegante -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <!-- Iconos Phosphor (para un toque visual) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
    <style>
        /* Estilos base del cuerpo y fondo general */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3ed; /* Color crema suave de la invitación */
            line-height: 1.6;
            color: #333;
        }
        /* Estilos para las tarjetas de cada sección del panel */
        .container-card {
            background-color: #ffffff; /* Blanco limpio */
            border-radius: 1rem; /* Más redondeado */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 5px 10px rgba(0, 0, 0, 0.08); /* Sombra más pronunciada pero suave */
            border: 2px solid #e0d8cc; /* Borde más visible y elegante */
            padding: 2.5rem; /* Más padding para espacio */
            margin: 2rem auto; /* Más margen para separación */
            max-width: 95%; /* Más ancho en móviles */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Mayor espacio entre elementos internos */
            transition: all 0.3s ease-in-out; /* Transición suave para efectos */
        }
        .container-card:hover {
            transform: translateY(-5px); /* Efecto de "levantar" al pasar el ratón */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2), 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        /* Estilo para los títulos de cada sección (Confirmaciones, Canciones, Mensajes) */
        .section-title {
            font-family: 'Playfair Display', serif; /* Fuente de títulos de la invitación */
            font-size: 2.25rem; /* text-4xl para más impacto */
            font-weight: 700; /* font-bold */
            color: #a07a1e; /* Color dorado más vibrante */
            margin-bottom: 1.5rem; /* Más espacio */
            text-align: center;
            border-bottom: 2px solid #e0d8cc; /* Borde inferior suave */
            padding-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* Sombra de texto ligera */
        }
        .section-title i {
            margin-right: 0.5rem;
            color: #d4af37; /* Dorado más claro para el icono */
        }

        /* Estilo para el título principal del panel */
        .main-title {
            font-family: 'Great Vibes', cursive; /* Fuente elegante de los nombres en la invitación */
            font-size: 4.5rem; /* Aumentado para destacarse aún más */
            font-weight: 700;
            color: #a07a1e; /* Color dorado principal */
            text-align: center;
            margin-top: 3rem;
            margin-bottom: 2.5rem;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3); /* Sombra más profunda */
        }

        /* Estilo para cada elemento de la lista (un RSVP, una canción, un mensaje) */
        .list-item {
            background-color: #fdfaf7; /* Un blanco roto, ligeramente más cálido y premium */
            padding: 1.5rem; /* Más padding */
            border-radius: 0.75rem; /* Más redondeado */
            margin-bottom: 1rem; /* Espacio entre items */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05); /* Sombra interna y externa sutil */
            border: 1px solid #f0e6da; /* Borde muy suave */
            transition: background-color 0.2s ease;
        }
        .list-item:hover {
            background-color: #fcf6f0; /* Un sutil cambio de color al pasar el ratón */
        }
        .list-item:last-child {
            margin-bottom: 0;
        }
        .list-item p {
            font-size: 1.05rem; /* Ligeramente más grande para legibilidad */
            color: #4B5563; /* Gris oscuro para legibilidad */
            margin-bottom: 0.4rem;
        }
        .list-item span {
            font-weight: 700; /* Más negrita para etiquetas */
            color: #2D3748; /* Un gris más oscuro para etiquetas */
        }
        .list-item .status-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Píldora */
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .status-confirmed {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .status-declined {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .status-na {
            background-color: #e2e8f0; /* gray-200 */
            color: #4a5568; /* gray-700 */
        }


        .loading-text, .empty-state {
            text-align: center;
            font-style: italic;
            color: #718096; /* Gris medio */
            padding: 2rem;
            border: 1px dashed #dbe0e7; /* Borde más suave */
            border-radius: 0.75rem;
            background-color: #fdfdfc; /* Fondo casi blanco */
            font-size: 1.1rem;
        }
        .message-error-dashboard {
            color: #EF4444; /* Tailwind red-500 */
            font-weight: 600;
        }

        /* Ajustes responsivos */
        @media (max-width: 768px) {
            .main-title { font-size: 3.5rem; } /* Más pequeño para móvil */
            .section-title { font-size: 1.75rem; }
            .container-card { padding: 1.5rem; margin: 1.5rem auto; }
            .list-item { padding: 1.25rem; }
        }
        @media (min-width: 1024px) {
            .container-card {
                max-width: 860px; /* lg:max-w-3xl for larger screens */
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">
    <h1 class="main-title">Panel de Control</h1>

    <div class="container-card">
        <h2 class="section-title"><i class="ph ph-calendar-blank"></i> Confirmaciones de Asistencia (RSVP)</h2>
        <div id="rsvpsList" class="space-y-3">
            <p class="loading-text">Cargando confirmaciones...</p>
        </div>
    </div>

    <div class="container-card">
        <h2 class="section-title"><i class="ph ph-music-note"></i> Sugerencias de Canciones</h2>
        <div id="songRequestsList" class="space-y-3">
            <p class="loading-text">Cargando sugerencias de canciones...</p>
        </div>
    </div>

    <div class="container-card">
        <h2 class="section-title"><i class="ph ph-notebook"></i> Mensajes del Libro de Firmas</h2>
        <div id="guestbookEntriesList" class="space-y-3">
            <p class="loading-text">Cargando mensajes del libro...</p>
        </div>
    </div>

    <!-- SDKs de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // TU CONFIGURACIÓN DE FIREBASE (PROYECTO: MiAppboda)
        const firebaseConfig = {
            apiKey: "AIzaSyDpAxNRADMfHkSlxBpJIe9WaB3_rWz1Vd4",
            authDomain: "miappboda.firebaseapp.com",
            projectId: "miappboda",
            storageBucket: "miappboda.firebasestorage.app",
            messagingSenderId: "155595716187",
            appId: "1:155595716187:web:11ba23c2bde759bcf0717e",
            measurementId: "G-CL89DVBBHP" 
        };
        
        const appId = firebaseConfig.appId;
        let db, auth;
        let isAuthReady = false;

        // Función para mostrar mensajes de error/estado en el dashboard
        function displayStatus(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<p class="${isError ? 'message-error-dashboard' : 'text-gray-600'} text-center italic">${message}</p>`;
            }
        }

        // Inicializa Firebase y autentica anónimamente
        const initializeFirebase = async () => {
            try {
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing API key. Cannot initialize Firebase.");
                    displayStatus('rsvpsList', "Error: Configuración de Firebase incompleta.");
                    displayStatus('songRequestsList', "Error: Configuración de Firebase incompleta.");
                    displayStatus('guestbookEntriesList', "Error: Configuración de Firebase incompleta.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // onAuthStateChanged se dispara cuando cambia el estado de autenticación
                // Esto asegura que tengamos un usuario (anónimo o no) antes de intentar acceder a Firestore
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            await signInAnonymously(auth); // Intenta iniciar sesión anónimamente
                        } catch (error) {
                            console.error("Firebase Anonymous Sign-in Error:", error);
                            displayStatus('rsvpsList', "Error de autenticación. Revisa que la autenticación anónima esté habilitada en tu proyecto Firebase.", true);
                            displayStatus('songRequestsList', "Error de autenticación. Revisa que la autenticación anónima esté habilitada en tu proyecto Firebase.", true);
                            displayStatus('guestbookEntriesList', "Error de autenticación. Revisa que la autenticación anónima esté habilitada en tu proyecto Firebase.", true);
                            return; // Salir si la autenticación falla
                        }
                    }
                    // Si llegamos aquí, la autenticación fue exitosa o ya había un usuario
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. Loading data...");
                    // Cargar datos una vez que la autenticación esté lista
                    loadRsvps();
                    loadSongRequests();
                    loadGuestbookEntries();
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                displayStatus('rsvpsList', "Error al inicializar Firebase. Posiblemente un problema de configuración de Firebase.", true);
                displayStatus('songRequestsList', "Error al inicializar Firebase. Posiblemente un problema de configuración de Firebase.", true);
                displayStatus('guestbookEntriesList', "Error al inicializar Firebase. Posiblemente un problema de configuración de Firebase.", true);
            }
        };

        // Cargar y mostrar RSVPs en tiempo real
        const loadRsvps = () => {
            if (!db || !isAuthReady) {
                 displayStatus('rsvpsList', "La base de datos no está lista para cargar datos.", true);
                 return;
            }
            // Realiza la consulta solo si la autenticación anónima está habilitada
            // y las reglas de seguridad lo permiten
            const q = query(collection(db, `artifacts/${appId}/public/data/rsvps`));
            onSnapshot(q, (snapshot) => {
                const rsvpsList = document.getElementById('rsvpsList');
                rsvpsList.innerHTML = ''; // Limpiar lista
                if (snapshot.empty) {
                    rsvpsList.innerHTML = '<p class="empty-state">No hay confirmaciones de asistencia aún.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    const statusClass = data.status === 'confirmed' ? 'status-confirmed' : 'status-declined';
                    const statusText = data.status === 'confirmed' ? 'Confirmado' : 'No Asistirá';
                    listItem.innerHTML = `
                        <p><span>Nombre:</span> ${data.guestName}</p>
                        <p><span>Adultos:</span> ${data.adults}</p>
                        <p><span>Menores:</span> ${data.minors}</p>
                        <p><span>Estado:</span> <span class="${statusClass} status-tag">${statusText}</span></p>
                        <p class="text-xs text-gray-500"><span>Fecha:</span> ${new Date(data.timestamp.seconds * 1000).toLocaleString()}</p>
                    `;
                    rsvpsList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error al cargar RSVPs:", error);
                displayStatus('rsvpsList', "Error al cargar confirmaciones de asistencia. Revisa las reglas de seguridad de Firestore.", true);
            });
        };

        // Cargar y mostrar solicitudes de canciones en tiempo real
        const loadSongRequests = () => {
            if (!db || !isAuthReady) {
                displayStatus('songRequestsList', "La base de datos no está lista para cargar datos.", true);
                return;
            }
            const q = query(collection(db, `artifacts/${appId}/public/data/songRequests`));
            onSnapshot(q, (snapshot) => {
                const songRequestsList = document.getElementById('songRequestsList');
                songRequestsList.innerHTML = ''; // Limpiar lista
                if (snapshot.empty) {
                    songRequestsList.innerHTML = '<p class="empty-state">No hay sugerencias de canciones aún.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <p><span>Canción:</span> ${data.songName}</p>
                        <p><span>Artista:</span> ${data.songArtist || 'N/A'}</p>
                        <p><span>Sugerido por:</span> ${data.requesterName || 'Anónimo'}</p>
                        <p class="text-xs text-gray-500"><span>Fecha:</span> ${new Date(data.timestamp.seconds * 1000).toLocaleString()}</p>
                    `;
                    songRequestsList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error al cargar solicitudes de canciones:", error);
                displayStatus('songRequestsList', "Error al cargar sugerencias de canciones. Revisa las reglas de seguridad de Firestore.", true);
            });
        };

        // Cargar y mostrar entradas del libro de firmas en tiempo real
        const loadGuestbookEntries = () => {
            if (!db || !isAuthReady) {
                displayStatus('guestbookEntriesList', "La base de datos no está lista para cargar datos.", true);
                return;
            }
            const q = query(collection(db, `artifacts/${appId}/public/data/guestbookEntries`));
            onSnapshot(q, (snapshot) => {
                const guestbookEntriesList = document.getElementById('guestbookEntriesList');
                guestbookEntriesList.innerHTML = ''; // Limpiar lista
                if (snapshot.empty) {
                    guestbookEntriesList.innerHTML = '<p class="empty-state">No hay mensajes en el libro de firmas aún.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <p><span>Mensaje:</span> ${data.message}</p>
                        <p><span>Firmado por:</span> ${data.signer}</p>
                        <p class="text-xs text-gray-500"><span>Fecha:</span> ${new Date(data.timestamp.seconds * 1000).toLocaleString()}</p>
                    `;
                    guestbookEntriesList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error al cargar entradas del libro de firmas:", error);
                displayStatus('guestbookEntriesList', "Error al cargar mensajes del libro de firmas. Revisa las reglas de seguridad de Firestore.", true);
            });
        };

        // Inicia la inicialización de Firebase cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>